rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function userDocExists() {
      return signedIn() && exists(/databases/$(database)/documents/users/$(uid()));
    }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(uid())).data;
    }

    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == 'lucassteckel04@gmail.com' ||
        (userDocExists() && userDoc().role == 'admin')
      );
    }

    function isOwner(userId) {
      return signedIn() && uid() == userId;
    }

    function isValidUsername(name) {
      return name is string &&
        name.size() >= 3 &&
        name.size() <= 32 &&
        name.matches('^[a-zA-Z0-9._-]+$');
    }

    function isValidEmail(email) {
      return email is string &&
        email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }

    function isValidMessage(text) {
      return text is string &&
        text.size() >= 1 &&
        text.size() <= 4000;
    }

    // =========================
    // USERS
    // =========================

    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();

      allow create: if isOwner(userId)
        && request.resource.data.uid == userId
        && isValidUsername(request.resource.data.username)
        && isValidEmail(request.resource.data.email);

      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // =========================
    // USERNAME INDEX
    // =========================

    match /usernames/{username} {
      allow read: if true;
      allow create: if signedIn()
        && request.resource.data.uid == uid()
        && isValidUsername(username)
        && !exists(/databases/$(database)/documents/usernames/$(username));
      allow update, delete: if isAdmin();
    }

    // =========================
    // BLOG POSTS + COMMENTS
    // =========================

    match /posts/{postId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn()
          && request.resource.data.uid == uid()
          && request.resource.data.content is string
          && request.resource.data.content.size() <= 2000;
        allow update, delete: if isAdmin() || (signedIn() && resource.data.uid == uid());
      }
    }

    // =========================
    // FRIENDS
    // =========================

    match /friends/{friendId} {
      allow read: if signedIn() && (isAdmin() || resource.data.users.hasAny([uid()]));
      allow create: if signedIn() && (isAdmin() || request.resource.data.users.hasAny([uid()]));
      allow update, delete: if signedIn() && (isAdmin() || resource.data.users.hasAny([uid()]));
    }

    // =========================
    // GROUPS / SERVERS
    // =========================

    match /groups/{groupId} {
      allow read: if signedIn() && (
        resource.data.isPublic == true ||
        resource.data.members.hasAny([uid()]) ||
        isAdmin()
      );

      allow create: if signedIn();

      allow update, delete: if signedIn() && (
        isAdmin() ||
        resource.data.ownerId == uid() ||
        resource.data.admins.hasAny([uid()])
      );
    }

    // =========================
    // CHATS
    // =========================

    match /chats/{chatId} {
      function isChatMember() {
        return exists(/databases/$(database)/documents/chats/$(chatId)) &&
          get(/databases/$(database)/documents/chats/$(chatId)).data.members.hasAny([uid()]);
      }

      allow read: if signedIn() && isChatMember();
      allow create: if signedIn() && request.resource.data.members.hasAny([uid()]);
      allow update, delete: if signedIn() && (isChatMember() || isAdmin());

      match /messages/{messageId} {
        allow read: if signedIn() && isChatMember();
        allow create: if signedIn()
          && isChatMember()
          && request.resource.data.senderId == uid()
          && isValidMessage(request.resource.data.content);
        allow update, delete: if signedIn() && (request.resource.data.senderId == uid() || isAdmin());
      }
    }

    // =========================
    // STREAMS
    // =========================

    match /streams/{streamId} {
      allow read: if true;
      allow create: if signedIn() && (isAdmin() || (userDocExists() && userDoc().role == 'streamer'));
      allow update, delete: if signedIn() && (isAdmin() || resource.data.streamerId == uid());
    }

    // =========================
    // Q&A
    // =========================

    match /qa/{qaId} {
      allow read: if signedIn();
      allow create: if signedIn();
      allow update, delete: if signedIn() && (isAdmin() || resource.data.authorId == uid());
    }

    // =========================
    // NOTIFICATIONS
    // =========================

    match /notifications/{notificationId} {
      allow read, write: if signedIn() && (isAdmin() || resource.data.userId == uid());
    }

    // =========================
    // ADMIN
    // =========================

    match /admin/{doc=**} {
      allow read, write: if isAdmin();
    }

    // =========================
    // DEFAULT DENY
    // =========================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

