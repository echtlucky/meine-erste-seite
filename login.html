<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | echtlucky</title>

  <!-- Base -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Components (Cards, Buttons, Inputs, Tabs, etc.) -->
  <link rel="stylesheet" href="css/components.css" />

  <!-- Page-specific -->
  <link rel="stylesheet" href="css/pages/login.css" />
</head>

<body class="page-transition login-page">
  <!-- Header via fetch -->
  <div id="header-placeholder"></div>

  <main class="auth-shell">
    <div class="auth-wrap">

      <!-- Cards -->
      <div class="auth-grid">

        <!-- Left: Visual / Content -->
        <section class="auth-visual">
          <div>
            <div class="badge">⚡ echtlucky • Competitive</div>

            <h1>Willkommen zurück.</h1>

            <p>
              Log dich ein, join den Grind und bleib up-to-date bei Ballistic & Ranked.
              Clean, schnell, ohne Drama.
            </p>

            <div class="bullets">
              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Community</strong><br />
                  <span class="hint">Scrims, Customs, VOD-Talk, Team-Suche.</span>
                </div>
              </div>

              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Blog</strong><br />
                  <span class="hint">Updates, Guides, Insights — alles an einem Ort.</span>
                </div>
              </div>

              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Account</strong><br />
                  <span class="hint">Username, Admin-Features (wenn freigeschaltet).</span>
                </div>
              </div>
            </div>
          </div>

          <p class="hint hint--strong">
            Tipp: Du kannst dich auch mit <strong class="fw-820">Username</strong> anmelden, wenn du einen gesetzt hast.
          </p>
        </section>

        <!-- Right: Auth Card -->
        <section class="auth-card">
          <div class="auth-card__top">
            <div class="tabs" role="tablist" aria-label="Auth Tabs">
              <button class="tab active" id="tabLogin" type="button">Login</button>
              <button class="tab" id="tabRegister" type="button">Registrieren</button>
            </div>
          </div>

          <div class="auth-card__body">
            <div id="msgBox" class="msg"></div>

            <!-- LOGIN FORM -->
            <form id="loginForm">
              <div class="field">
                <label for="loginIdentifier">E-Mail oder Username</label>
                <input
                  id="loginIdentifier"
                  class="input"
                  type="text"
                  autocomplete="username"
                  placeholder="Nutzername: max1234 oder Email: maxmustermann@gmail.com"
                  required
                />
                <div class="hint">Wenn du Username nutzt, wird er automatisch zu deiner E-Mail aufgelöst.</div>
              </div>

              <div class="field">
                <label for="loginPassword">Passwort</label>
                <input
                  id="loginPassword"
                  class="input"
                  type="password"
                  autocomplete="current-password"
                  placeholder="••••••••"
                  required
                />
              </div>

              <div class="row">
                <a href="#" class="small-link" id="forgotPw">Passwort vergessen?</a>
              </div>

              <button class="btn-full" type="submit">Einloggen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleLoginBtn">
                <span class="google-g">G</span> Mit Google anmelden
              </button>
            </form>

            <!-- REGISTER FORM -->
            <form id="registerForm" class="hidden">
              <div class="field">
                <label for="regUsername">Username</label>
                <input
                  id="regUsername"
                  class="input"
                  type="text"
                  autocomplete="nickname"
                  placeholder="z.B. echtlucky"
                  required
                />
                <div class="hint">A-Z / 0-9 / _ / . / - • 3–20 Zeichen</div>
              </div>

              <div class="field">
                <label for="regEmail">E-Mail</label>
                <input
                  id="regEmail"
                  class="input"
                  type="email"
                  autocomplete="email"
                  placeholder="name@email.de"
                  required
                />
              </div>

              <div class="field">
                <label for="regPassword">Passwort</label>
                <input
                  id="regPassword"
                  class="input"
                  type="password"
                  autocomplete="new-password"
                  placeholder="mind. 6 Zeichen"
                  required
                />
              </div>

              <button class="btn-full" type="submit">Account erstellen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleRegisterBtn">
                <span class="google-g">G</span> Mit Google starten
              </button>

              <p class="hint hint--compact">
                Mit Registrierung akzeptierst du die Inhalte als privat & nicht-kommerziell.
              </p>
            </form>
          </div>
        </section>
      </div>

      <!-- Latest Blog (unten) -->
      <section class="auth-latest" id="latestPostCard" aria-live="polite">
        <div class="auth-latest__meta">Letzter Blog</div>
        <h2 class="auth-latest__title" id="latestPostTitle">Lädt...</h2>
        <p class="auth-latest__text" id="latestPostText">Bitte einen Moment.</p>
        <a class="auth-latest__cta" id="latestPostLink" href="blog.html">Zum Blog →</a>
      </section>

    </div>
  </main>

  <!-- Footer via fetch -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>

  <script>
    async function loadLatestPostIntoLogin() {
      const titleEl = document.getElementById("latestPostTitle");
      const textEl = document.getElementById("latestPostText");
      const linkEl = document.getElementById("latestPostLink");
      if (!titleEl || !textEl || !linkEl) return;

      if (typeof window.db === "undefined") {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Firestore ist noch nicht bereit.";
        return;
      }

      try {
        const snap = await window.db
          .collection("posts")
          .orderBy("createdAt", "desc")
          .limit(1)
          .get();

        if (snap.empty) {
          titleEl.textContent = "Aktuell kein Blog vorhanden";
          textEl.textContent = "Sobald ein Beitrag online ist, wird er hier angezeigt.";
          linkEl.href = "blog.html";
          linkEl.textContent = "Zum Blog →";
          return;
        }

        const doc = snap.docs[0];
        const data = doc.data() || {};
        const title = data.title || "Neuer Beitrag";
        const content = (data.content || "").toString().trim();
        const excerpt = content.length > 220 ? content.slice(0, 220) + "…" : (content || "Beitrag ansehen.");

        titleEl.textContent = title;
        textEl.textContent = excerpt;

        linkEl.href = "blog.html";
        linkEl.textContent = "Beitrag lesen →";
      } catch (err) {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Konnte den Blog nicht laden: " + err.message;
        linkEl.href = "blog.html";
        linkEl.textContent = "Zum Blog →";
      }
    }

    document.addEventListener("DOMContentLoaded", loadLatestPostIntoLogin);
  </script>

  <script>
    document.body.classList.add('loaded');

    // Header laden + init
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        if (typeof initHeaderScripts === "function") initHeaderScripts();
        if (typeof initSmartHeaderScroll === "function") initSmartHeaderScroll();
      });

    // Footer laden
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ====== UI helpers ======
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const msgBox = document.getElementById('msgBox');

    function showMsg(text, type="error"){
      msgBox.textContent = text;
      msgBox.className = "msg " + (type === "success" ? "success" : "error");
      msgBox.style.display = "block";
    }
    function clearMsg(){
      msgBox.style.display = "none";
      msgBox.textContent = "";
      msgBox.className = "msg";
    }

    function setTab(mode){
      clearMsg();
      if (mode === "login"){
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      } else {
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      }
    }
    tabLogin.addEventListener('click', () => setTab("login"));
    tabRegister.addEventListener('click', () => setTab("register"));

    // ====== Username → Email resolver ======
    async function resolveEmailFromIdentifier(identifierRaw){
      const identifier = (identifierRaw || "").trim();
      if (!identifier) throw new Error("Bitte E-Mail oder Username eingeben.");

      if (identifier.includes("@")) return identifier;

      const uname = identifier.toLowerCase();
      if (!window.db) throw new Error("DB nicht verfügbar. Prüfe firebase.js + Firestore SDK.");

      const doc = await db.collection("usernames").doc(uname).get();
      if (!doc.exists) throw new Error("Username nicht gefunden.");
      const data = doc.data();
      if (!data?.email) throw new Error("Username ist nicht korrekt verknüpft.");
      return data.email;
    }

    function isValidUsername(u){
      const v = (u || "").trim();
      if (v.length < 3 || v.length > 20) return false;
      return /^[a-zA-Z0-9_.-]+$/.test(v);
    }

    // ====== LOGIN ======
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value;
      const password = document.getElementById('loginPassword').value;

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.signInWithEmailAndPassword(email, password);
        showMsg("Eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Login fehlgeschlagen.");
      }
    });

    // ====== REGISTER ======
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!isValidUsername(username)){
        showMsg("Username ungültig. Erlaubt: A-Z, 0-9, _ . - (3–20 Zeichen).");
        return;
      }

      try{
        const unameLower = username.toLowerCase();
        const existing = await db.collection("usernames").doc(unameLower).get();
        if (existing.exists){
          showMsg("Username ist schon vergeben.");
          return;
        }

        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await cred.user.updateProfile({ displayName: username });

        await db.collection("usernames").doc(unameLower).set({
          email: email,
          uid: cred.user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg("Account erstellt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Registrierung fehlgeschlagen.");
      }
    });

    // ====== GOOGLE AUTH ======
    async function googleSignIn(){
      clearMsg();
      try{
        const result = await auth.signInWithPopup(googleProvider);

        const u = result.user;
        if (u?.displayName){
          const unameLower = u.displayName.toLowerCase().replace(/\s+/g, "").slice(0,20);
          const docRef = db.collection("usernames").doc(unameLower);
          const snap = await docRef.get();
          if (!snap.exists){
            await docRef.set({
              email: u.email,
              uid: u.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        showMsg("Mit Google eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Google Login fehlgeschlagen.");
      }
    }

    document.getElementById('googleLoginBtn').addEventListener('click', googleSignIn);
    document.getElementById('googleRegisterBtn').addEventListener('click', googleSignIn);

    // ====== PASSWORD RESET ======
    document.getElementById('forgotPw').addEventListener('click', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value.trim();
      if (!identifier){
        showMsg("Bitte zuerst E-Mail oder Username eingeben.");
        return;
      }

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.sendPasswordResetEmail(email);
        showMsg("Reset-Mail wurde gesendet (falls die Adresse existiert).", "success");
      }catch(err){
        showMsg(err?.message || "Reset fehlgeschlagen.");
      }
    });

    // If already logged in, redirect
    auth.onAuthStateChanged((user) => {
      if (user) window.location.href = "index.html";
    });
  </script>
</body>
</html>