<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/pages/login.css" />
</head>

<body class="page-transition login-page">
  <!-- Header via fetch -->
  <div id="header-placeholder"></div>

  <main class="auth-shell">
    <div class="auth-wrap">

      <div class="auth-grid">

        <!-- Left: Visual / Content -->
        <section class="auth-visual">
          <div>
            <div class="auth-badge">⚡ echtlucky • Competitive</div>

            <h1>Willkommen zurück.</h1>

            <p>
              Log dich ein, join den Grind und bleib up-to-date bei Ballistic & Ranked.
              Clean, schnell, ohne Drama.
            </p>

            <div class="bullets">
              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Community</strong><br />
                  <span class="hint">Scrims, Customs, VOD-Talk, Team-Suche.</span>
                </div>
              </div>

              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Blog</strong><br />
                  <span class="hint">Updates, Guides, Insights — alles an einem Ort.</span>
                </div>
              </div>

              <div class="bullet">
                <span class="dot"></span>
                <div>
                  <strong class="fw-820">Account</strong><br />
                  <span class="hint">Username, Admin-Features (wenn freigeschaltet).</span>
                </div>
              </div>
            </div>
          </div>

          <p class="hint hint--strong">
            Tipp: Du kannst dich auch mit <strong class="fw-820">Username</strong> anmelden, wenn du einen gesetzt hast.
          </p>
        </section>

        <!-- Right: Auth Card -->
        <section class="auth-card">
          <div class="auth-card__top">
            <div class="tabs" role="tablist" aria-label="Auth Tabs">
              <button class="tab active" id="tabLogin" type="button">Login</button>
              <button class="tab" id="tabRegister" type="button">Registrieren</button>
            </div>
          </div>

          <div class="auth-card__body">
            <div id="msgBox" class="msg" style="display:none;"></div>

            <!-- LOGIN FORM -->
            <form id="loginForm">
              <div class="field">
                <label for="loginIdentifier">E-Mail oder Username</label>
                <input
                  id="loginIdentifier"
                  class="input"
                  type="text"
                  autocomplete="username"
                  placeholder="Nutzername: max1234 oder Email: maxmustermann@gmail.com"
                  required
                />
                <div class="hint">Wenn du Username nutzt, wird er automatisch zu deiner E-Mail aufgelöst.</div>
              </div>

              <div class="field">
                <label for="loginPassword">Passwort</label>
                <input
                  id="loginPassword"
                  class="input"
                  type="password"
                  autocomplete="current-password"
                  placeholder="••••••••"
                  required
                />
              </div>

              <div class="row">
                <a href="#" class="small-link" id="forgotPw">Passwort vergessen?</a>
              </div>

              <button class="btn-full" type="submit">Einloggen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleLoginBtn">
                <span class="google-g">G</span> Mit Google anmelden
              </button>
            </form>

            <!-- REGISTER FORM -->
            <form id="registerForm" class="hidden">
              <div class="field">
                <label for="regUsername">Username</label>
                <input
                  id="regUsername"
                  class="input"
                  type="text"
                  autocomplete="nickname"
                  placeholder="z.B. echtlucky"
                  required
                />
                <div class="hint">A-Z / 0-9 / _ / . / - • 3–20 Zeichen</div>
              </div>

              <div class="field">
                <label for="regEmail">E-Mail</label>
                <input
                  id="regEmail"
                  class="input"
                  type="email"
                  autocomplete="email"
                  placeholder="name@email.de"
                  required
                />
              </div>

              <div class="field">
                <label for="regPassword">Passwort</label>
                <input
                  id="regPassword"
                  class="input"
                  type="password"
                  autocomplete="new-password"
                  placeholder="mind. 6 Zeichen"
                  required
                />
              </div>

              <button class="btn-full" type="submit">Account erstellen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleRegisterBtn">
                <span class="google-g">G</span> Mit Google starten
              </button>

              <p class="hint hint--compact">
                Mit Registrierung akzeptierst du die Inhalte als privat & nicht-kommerziell.
              </p>
            </form>
          </div>
        </section>

      </div>

      <!-- Latest Blog (unten) -->
      <section class="auth-latest" id="latestPostCard" aria-live="polite">
        <div class="auth-latest__meta">Letzter Blog</div>
        <h2 class="auth-latest__title" id="latestPostTitle">Lädt…</h2>
        <p class="auth-latest__text" id="latestPostText">Bitte einen Moment.</p>
        <a class="auth-latest__cta" id="latestPostLink" href="blog.html">Zum Blog →</a>
      </section>

    </div>
  </main>

  <!-- Footer via fetch -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- Your setup -->
  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>
  <script src="js/login.js"></script>

  <script>
    document.body.classList.add('loaded');

    // Header laden + init
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        if (typeof initHeaderScripts === "function") initHeaderScripts();
        if (typeof initSmartHeaderScroll === "function") initSmartHeaderScroll();
      });

    // Footer laden
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ===== Latest Blog Preview =====
    async function loadLatestPostIntoLogin() {
      const titleEl = document.getElementById("latestPostTitle");
      const textEl  = document.getElementById("latestPostText");
      const linkEl  = document.getElementById("latestPostLink");
      if (!titleEl || !textEl || !linkEl) return;

      // db muss in firebase.js als global existieren: const db = firebase.firestore();
      if (typeof db === "undefined") {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Firestore ist noch nicht bereit (db fehlt in firebase.js).";
        return;
      }

      const stripHtml = (s) => String(s || "").replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
      const makeExcerpt = (s, max=180) => (s.length > max ? s.slice(0, max).trim() + "…" : s);

      try {
        // 1) try createdAt
        let snap;
        try {
          snap = await db.collection("posts").orderBy("createdAt", "desc").limit(1).get();
        } catch (e) {
          // 2) fallback to date
          snap = await db.collection("posts").orderBy("date", "desc").limit(1).get();
        }

        if (!snap || snap.empty) {
          titleEl.textContent = "Aktuell kein Blog vorhanden";
          textEl.textContent = "Sobald ein Beitrag online ist, wird er hier angezeigt.";
          linkEl.href = "blog.html";
          linkEl.textContent = "Zum Blog →";
          return;
        }

        const data = snap.docs[0].data() || {};
        const title = data.title || "Neuer Beitrag";
        const content = stripHtml(data.content || "");
        const excerpt = makeExcerpt(content || "Beitrag ansehen.", 190);

        titleEl.textContent = title;
        textEl.textContent = excerpt;

        linkEl.href = "blog.html";
        linkEl.textContent = "Beitrag lesen →";
      } catch (err) {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Konnte den Blog nicht laden: " + (err?.message || "Unbekannter Fehler");
        linkEl.href = "blog.html";
        linkEl.textContent = "Zum Blog →";
      }
    }

    document.addEventListener("DOMContentLoaded", loadLatestPostIntoLogin);
  </script>
</body>
</html>