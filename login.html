<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===========================
       LOGIN PAGE: Apple x Riot clean
       - mehr Höhe, mehr Luft
       - nicht gequetscht
       - Blog Card UNTEN
    ============================ */

    /* Wichtig: body class = login-page */
    .login-page .auth-shell{
      min-height: calc(100vh - 60px);
      width: 100%;
      padding: clamp(2rem, 4vw, 3.6rem);
      position: relative;
      isolation: isolate;

      /* NICHT mehr alles "gequetscht mittig" */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: clamp(1.8rem, 3vw, 2.6rem);
    }

    /* Background (safe an auth-shell) */
    .login-page .auth-shell::before{
      content:"";
      position:absolute;
      inset:-2px;
      z-index:-2;
      pointer-events:none;
      background:
        linear-gradient(rgba(0,0,0,0.72), rgba(0,0,0,0.88)),
        url('https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80&w=2400')
        center/cover no-repeat fixed;
    }

    .login-page .auth-shell::after{
      content:"";
      position:absolute;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:
        linear-gradient(to right, rgba(0,255,136,0.07) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,255,136,0.07) 1px, transparent 1px),
        radial-gradient(circle at 30% 20%, rgba(0,255,136,0.18), transparent 55%),
        radial-gradient(circle at 78% 75%, rgba(88,101,242,0.18), transparent 60%);
      background-size: 72px 72px, 72px 72px, cover, cover;
      opacity: 0.9;
      mix-blend-mode: screen;
    }

    /* Wrapper damit alles "centered" ist, aber nicht gequetscht */
    .auth-wrap{
      width: min(1180px, 100%);
      margin: 0 auto;
      display: grid;
      gap: clamp(1.6rem, 2.5vw, 2.4rem);
    }

    /* ===== Layout Grid (2 Cards) ===== */
    .auth-grid{
      width: 100%;
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: clamp(1.8rem, 3.2vw, 2.8rem);
      align-items: stretch;
    }

    /* Typo insgesamt leicht "dünner" (aber premium) */
    .login-page .auth-shell,
    .login-page .auth-shell *{
      font-weight: 560;
    }

    /* Headlines weiterhin stark, aber nicht "Brett" */
    .auth-visual h1{
      font-weight: 850;
    }
    .auth-latest__title{
      font-weight: 820;
    }
    .tab{
      font-weight: 820;
    }
    .btn-full,
    .btn-ghost,
    .auth-latest__cta{
      font-weight: 900;
    }
    .field label{
      font-weight: 780;
    }

    /* ===== LEFT VISUAL ===== */
    .auth-visual{
      border-radius: 28px;
      border: 1px solid rgba(0,255,136,0.16);
      background:
        radial-gradient(circle at 30% 20%, rgba(0,255,136,0.18), transparent 55%),
        radial-gradient(circle at 75% 70%, rgba(88,101,242,0.18), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.72));
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
      overflow: hidden;
      position: relative;

      padding: clamp(2.2rem, 3.2vw, 3.2rem);
      display: flex;
      flex-direction: column;
      justify-content: space-between;

      /* mehr Höhe -> mehr Übersicht */
      min-height: 720px;
    }

    .auth-visual .badge{
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      padding: .65rem 1.05rem;
      border-radius: 999px;
      border: 1px solid rgba(0,255,136,0.18);
      background: rgba(0,0,0,0.35);
      color: rgba(224,255,224,0.88);
      font-weight: 850;
      width: fit-content;
    }

    .auth-visual h1{
      margin-top: 1.6rem;
      font-size: clamp(2.35rem, 3.4vw, 3.3rem);
      letter-spacing: -1px;
      line-height: 1.10;
      background: linear-gradient(90deg, #00ff88, #00cc66);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-visual p{
      margin-top: 1.2rem;
      color: rgba(224,255,224,0.88);
      max-width: 60ch;
      font-size: 1.08rem;
      line-height: 1.7;
    }

    .auth-visual .bullets{
      margin-top: 2.2rem;
      display: grid;
      gap: 1.1rem;
      color: rgba(224,255,224,0.88);
    }

    .auth-visual .bullet{
      display:flex;
      gap: 1rem;
      align-items:flex-start;
      padding: 1.25rem 1.35rem;
      border-radius: 18px;
      border: 1px solid rgba(0,255,136,0.12);
      background: rgba(0,0,0,0.42);
    }

    .auth-visual .dot{
      width: 10px;
      height: 10px;
      margin-top: .48rem;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 18px rgba(0,255,136,0.35);
      flex-shrink: 0;
    }

    .hint{
      color: rgba(224,255,224,0.74);
      font-size: .98rem;
      line-height: 1.55;
    }

    /* ===== RIGHT CARD ===== */
    .auth-card{
      border-radius: 28px;
      border: 1px solid rgba(0,255,136,0.18);
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.72));
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
      overflow: hidden;
      display: flex;
      flex-direction: column;

      /* auch etwas höher */
      min-height: 720px;
    }

    .auth-card__top{
      padding: 1.9rem 2rem 1.4rem;
      border-bottom: 1px solid rgba(0,255,136,0.12);
      background: rgba(0,0,0,0.32);
    }

    .tabs{
      display:flex;
      gap:.7rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(0,255,136,0.14);
      padding: .5rem;
      border-radius: 999px;
      width: fit-content;
    }

    .tab{
      appearance: none;
      border: 0;
      cursor: pointer;
      padding: .78rem 1.25rem;
      border-radius: 999px;
      background: transparent;
      color: rgba(224,255,224,0.80);
      letter-spacing: -0.25px;
      opacity: .9;
      transition: all .18s ease;
    }

    .tab.active{
      background: rgba(0,255,136,0.14);
      color: #00ff88;
      box-shadow: 0 0 0 1px rgba(0,255,136,0.14) inset;
      opacity: 1;
    }

    .auth-card__body{
      padding: 2.2rem 2rem 2.6rem;
      display: grid;
      gap: 1.9rem; /* MEHR luft */
    }

    .field{
      display: grid;
      gap: .85rem;
    }

    .field label{
      color: rgba(224,255,224,0.90);
      font-size: .98rem;
      letter-spacing: -0.2px;
    }

    .input{
      width: 100%;
      padding: 1.25rem 1.2rem;
      border-radius: 18px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(0,0,0,0.55);
      color: #e0ffe0;
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease;
    }

    .input::placeholder{ color: rgba(224,255,224,0.55); }

    .input:focus{
      border-color: rgba(0,255,136,0.35);
      box-shadow: 0 0 0 4px rgba(0,255,136,0.10);
    }

    .row{
      display:flex;
      gap: 1.2rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: .25rem;
    }

    .small-link{
      color: #00ff88;
      text-decoration: none;
      font-weight: 820;
      opacity: .95;
    }
    .small-link:hover{ text-decoration: underline; }

    .divider{
      display:flex;
      align-items:center;
      gap: 1rem;
      color: rgba(224,255,224,0.55);
      font-weight: 820;
      margin: .5rem 0 .2rem;
    }
    .divider::before,
    .divider::after{
      content:"";
      height:1px;
      flex:1;
      background: rgba(0,255,136,0.12);
    }

    .btn-full{
      width: 100%;
      text-align: center;
      border-radius: 18px;
      border: 1px solid rgba(0,255,136,0.18);
      background: linear-gradient(180deg, rgba(0,255,136,0.92), rgba(0,204,102,0.85));
      color: #000;
      padding: 1.25rem 1rem;
      letter-spacing: -0.3px;
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,0.55);
    }
    .btn-full:hover{
      transform: translateY(-3px);
      filter: saturate(1.05);
      box-shadow: 0 20px 65px rgba(0,255,136,0.12), 0 14px 40px rgba(0,0,0,0.55);
    }

    .btn-ghost{
      width: 100%;
      border-radius: 18px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(255,255,255,0.04);
      color: #e0ffe0;
      padding: 1.18rem 1rem;
      cursor: pointer;
      transition: background .18s ease, transform .18s ease;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:.7rem;
    }
    .btn-ghost:hover{
      background: rgba(0,255,136,0.08);
      transform: translateY(-2px);
    }

    .msg{
      padding: 1.1rem 1.15rem;
      border-radius: 18px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(0,0,0,0.45);
      color: rgba(224,255,224,0.88);
      display:none;
    }
    .msg.error{
      border-color: rgba(255,51,102,0.35);
      background: rgba(255,51,102,0.10);
      color: #ffb6c8;
    }
    .msg.success{
      border-color: rgba(0,255,136,0.28);
      background: rgba(0,255,136,0.08);
      color: #e0ffe0;
    }

    .hidden{ display:none !important; }

    /* ===== Blog Card UNTEN ===== */
    .auth-latest{
      width: 100%;
      margin: 0;
      border-radius: 28px;
      border: 1px solid rgba(0,255,136,0.18);
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(0,0,0,0.70));
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
      padding: clamp(1.5rem, 2.2vw, 2.2rem);
      position: relative;
      overflow: hidden;
    }

    .auth-latest::before{
      content:"";
      position:absolute;
      inset:-1px;
      background:
        radial-gradient(circle at 15% 20%, rgba(0,255,136,0.16), transparent 55%),
        radial-gradient(circle at 85% 70%, rgba(88,101,242,0.14), transparent 60%);
      pointer-events:none;
    }

    .auth-latest__meta{
      position: relative;
      display:inline-flex;
      width: fit-content;
      padding: .55rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(0,255,136,0.18);
      background: rgba(0,0,0,0.35);
      color: rgba(224,255,224,0.85);
      font-weight: 820;
      letter-spacing: -0.2px;
      margin-bottom: 1rem;
    }

    .auth-latest__title{
      position: relative;
      font-size: clamp(1.35rem, 2.2vw, 1.95rem);
      letter-spacing: -0.8px;
      margin: 0 0 .65rem;
      color: #00ff88;
    }

    .auth-latest__text{
      position: relative;
      color: rgba(224,255,224,0.86);
      max-width: 95ch;
      line-height: 1.7;
      margin: 0 0 1.1rem;
    }

    .auth-latest__cta{
      position: relative;
      display:inline-flex;
      align-items:center;
      gap:.6rem;
      text-decoration:none;
      color:#000;
      background: linear-gradient(180deg, rgba(0,255,136,0.92), rgba(0,204,102,0.85));
      border: 1px solid rgba(0,255,136,0.18);
      border-radius: 16px;
      padding: .9rem 1.2rem;
      box-shadow: 0 14px 40px rgba(0,0,0,0.55);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }

    .auth-latest__cta:hover{
      transform: translateY(-2px);
      filter: saturate(1.05);
      box-shadow: 0 20px 65px rgba(0,255,136,0.12), 0 14px 40px rgba(0,0,0,0.55);
    }

    /* Responsive */
    @media (max-width: 980px){
      .auth-grid{ grid-template-columns: 1fr; }
      .auth-visual{ display:none; }
      .auth-card{ min-height: unset; }
    }
  </style>
</head>

<body class="page-transition login-page">
  <!-- Header via fetch -->
  <div id="header-placeholder"></div>

  <main class="auth-shell">
    <div class="auth-wrap">

      <!-- Cards -->
      <div class="auth-grid">

        <!-- Left: Visual / Content -->
        <section class="auth-visual">
          <div>
            <div class="badge">⚡ echtlucky • Competitive</div>
            <h1>Willkommen zurück.</h1>
            <p>
              Log dich ein, join den Grind und bleib up-to-date bei Ballistic & Ranked.
              Clean, schnell, ohne Drama.
            </p>

            <div class="bullets">
              <div class="bullet">
                <span class="dot"></span>
                <div><strong style="font-weight:820;">Community</strong><br><span class="hint">Scrims, Customs, VOD-Talk, Team-Suche.</span></div>
              </div>
              <div class="bullet">
                <span class="dot"></span>
                <div><strong style="font-weight:820;">Blog</strong><br><span class="hint">Updates, Guides, Insights — alles an einem Ort.</span></div>
              </div>
              <div class="bullet">
                <span class="dot"></span>
                <div><strong style="font-weight:820;">Account</strong><br><span class="hint">Username, Admin-Features (wenn freigeschaltet).</span></div>
              </div>
            </div>
          </div>

          <p class="hint" style="opacity:.92">
            Tipp: Du kannst dich auch mit <strong style="font-weight:820;">Username</strong> anmelden, wenn du einen gesetzt hast.
          </p>
        </section>

        <!-- Right: Auth Card -->
        <section class="auth-card">
          <div class="auth-card__top">
            <div class="tabs" role="tablist" aria-label="Auth Tabs">
              <button class="tab active" id="tabLogin" type="button">Login</button>
              <button class="tab" id="tabRegister" type="button">Registrieren</button>
            </div>
          </div>

          <div class="auth-card__body">
            <div id="msgBox" class="msg"></div>

            <!-- LOGIN FORM -->
            <form id="loginForm">
              <div class="field">
                <label for="loginIdentifier">E-Mail oder Username</label>
                <input id="loginIdentifier" class="input" type="text" autocomplete="username"
                       placeholder="Nutzername: max1234 oder Email: maxmustermann@gmail.com" required />
                <div class="hint">Wenn du Username nutzt, wird er automatisch zu deiner E-Mail aufgelöst.</div>
              </div>

              <div class="field">
                <label for="loginPassword">Passwort</label>
                <input id="loginPassword" class="input" type="password" autocomplete="current-password"
                       placeholder="••••••••" required />
              </div>

              <div class="row">
                <a href="#" class="small-link" id="forgotPw">Passwort vergessen?</a>
              </div>

              <button class="btn-full" type="submit">Einloggen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleLoginBtn">
                <span style="font-weight:900;">G</span> Mit Google anmelden
              </button>
            </form>

            <!-- REGISTER FORM -->
            <form id="registerForm" class="hidden">
              <div class="field">
                <label for="regUsername">Username</label>
                <input id="regUsername" class="input" type="text" autocomplete="nickname"
                       placeholder="z.B. echtlucky" required />
                <div class="hint">A-Z / 0-9 / _ / . / - • 3–20 Zeichen</div>
              </div>

              <div class="field">
                <label for="regEmail">E-Mail</label>
                <input id="regEmail" class="input" type="email" autocomplete="email"
                       placeholder="name@email.de" required />
              </div>

              <div class="field">
                <label for="regPassword">Passwort</label>
                <input id="regPassword" class="input" type="password" autocomplete="new-password"
                       placeholder="mind. 6 Zeichen" required />
              </div>

              <button class="btn-full" type="submit">Account erstellen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleRegisterBtn">
                <span style="font-weight:900;">G</span> Mit Google starten
              </button>

              <p class="hint" style="margin-top:.2rem;">
                Mit Registrierung akzeptierst du die Inhalte als privat & nicht-kommerziell.
              </p>
            </form>
          </div>
        </section>
      </div>

      <!-- ✅ Latest Blog (JETZT UNTEN) -->
      <section class="auth-latest" id="latestPostCard" aria-live="polite">
        <div class="auth-latest__meta">Letzter Blog</div>
        <h2 class="auth-latest__title" id="latestPostTitle">Lädt...</h2>
        <p class="auth-latest__text" id="latestPostText">Bitte einen Moment.</p>
        <a class="auth-latest__cta" id="latestPostLink" href="blog.html">Zum Blog →</a>
      </section>

    </div>
  </main>

  <!-- Footer via fetch -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>

  <script>
    async function loadLatestPostIntoLogin() {
      const titleEl = document.getElementById("latestPostTitle");
      const textEl = document.getElementById("latestPostText");
      const linkEl = document.getElementById("latestPostLink");
      if (!titleEl || !textEl || !linkEl) return;

      if (typeof window.db === "undefined") {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Firestore ist noch nicht bereit.";
        return;
      }

      try {
        const snap = await window.db
          .collection("posts")
          .orderBy("createdAt", "desc")
          .limit(1)
          .get();

        if (snap.empty) {
          titleEl.textContent = "Aktuell kein Blog vorhanden";
          textEl.textContent = "Sobald ein Beitrag online ist, wird er hier angezeigt.";
          linkEl.href = "blog.html";
          linkEl.textContent = "Zum Blog →";
          return;
        }

        const doc = snap.docs[0];
        const data = doc.data() || {};
        const title = data.title || "Neuer Beitrag";
        const content = (data.content || "").toString().trim();
        const excerpt = content.length > 220 ? content.slice(0, 220) + "…" : (content || "Beitrag ansehen.");

        titleEl.textContent = title;
        textEl.textContent = excerpt;

        linkEl.href = "blog.html";
        linkEl.textContent = "Beitrag lesen →";
      } catch (err) {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Konnte den Blog nicht laden: " + err.message;
        linkEl.href = "blog.html";
        linkEl.textContent = "Zum Blog →";
      }
    }

    document.addEventListener("DOMContentLoaded", loadLatestPostIntoLogin);
  </script>

  <script>
    document.body.classList.add('loaded');

    // Header laden + init
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        if (typeof initHeaderScripts === "function") initHeaderScripts();
        if (typeof initSmartHeaderScroll === "function") initSmartHeaderScroll();
      });

    // Footer laden
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ====== UI helpers ======
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const msgBox = document.getElementById('msgBox');

    function showMsg(text, type="error"){
      msgBox.textContent = text;
      msgBox.className = "msg " + (type === "success" ? "success" : "error");
      msgBox.style.display = "block";
    }
    function clearMsg(){
      msgBox.style.display = "none";
      msgBox.textContent = "";
      msgBox.className = "msg";
    }

    function setTab(mode){
      clearMsg();
      if (mode === "login"){
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      } else {
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      }
    }
    tabLogin.addEventListener('click', () => setTab("login"));
    tabRegister.addEventListener('click', () => setTab("register"));

    // ====== Username → Email resolver ======
    // Collection: usernames (docId = usernameLower)
    // doc: { email: "..." }
    async function resolveEmailFromIdentifier(identifierRaw){
      const identifier = (identifierRaw || "").trim();
      if (!identifier) throw new Error("Bitte E-Mail oder Username eingeben.");

      if (identifier.includes("@")) return identifier;

      const uname = identifier.toLowerCase();
      if (!window.db) throw new Error("DB nicht verfügbar. Prüfe firebase.js + Firestore SDK.");

      const doc = await db.collection("usernames").doc(uname).get();
      if (!doc.exists) throw new Error("Username nicht gefunden.");
      const data = doc.data();
      if (!data?.email) throw new Error("Username ist nicht korrekt verknüpft.");
      return data.email;
    }

    function isValidUsername(u){
      const v = (u || "").trim();
      if (v.length < 3 || v.length > 20) return false;
      return /^[a-zA-Z0-9_.-]+$/.test(v);
    }

    // ====== LOGIN ======
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value;
      const password = document.getElementById('loginPassword').value;

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.signInWithEmailAndPassword(email, password);
        showMsg("Eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Login fehlgeschlagen.");
      }
    });

    // ====== REGISTER ======
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!isValidUsername(username)){
        showMsg("Username ungültig. Erlaubt: A-Z, 0-9, _ . - (3–20 Zeichen).");
        return;
      }

      try{
        const unameLower = username.toLowerCase();
        const existing = await db.collection("usernames").doc(unameLower).get();
        if (existing.exists){
          showMsg("Username ist schon vergeben.");
          return;
        }

        const cred = await auth.createUserWithEmailAndPassword(email, password);
        await cred.user.updateProfile({ displayName: username });

        await db.collection("usernames").doc(unameLower).set({
          email: email,
          uid: cred.user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg("Account erstellt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Registrierung fehlgeschlagen.");
      }
    });

    // ====== GOOGLE AUTH ======
    async function googleSignIn(){
      clearMsg();
      try{
        const result = await auth.signInWithPopup(googleProvider);

        const u = result.user;
        if (u?.displayName){
          const unameLower = u.displayName.toLowerCase().replace(/\s+/g, "").slice(0,20);
          const docRef = db.collection("usernames").doc(unameLower);
          const snap = await docRef.get();
          if (!snap.exists){
            await docRef.set({
              email: u.email,
              uid: u.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        showMsg("Mit Google eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Google Login fehlgeschlagen.");
      }
    }

    document.getElementById('googleLoginBtn').addEventListener('click', googleSignIn);
    document.getElementById('googleRegisterBtn').addEventListener('click', googleSignIn);

    // ====== PASSWORD RESET ======
    document.getElementById('forgotPw').addEventListener('click', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value.trim();
      if (!identifier){
        showMsg("Bitte zuerst E-Mail oder Username eingeben.");
        return;
      }

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.sendPasswordResetEmail(email);
        showMsg("Reset-Mail wurde gesendet (falls die Adresse existiert).", "success");
      }catch(err){
        showMsg(err?.message || "Reset fehlgeschlagen.");
      }
    });

    // If already logged in, redirect
    auth.onAuthStateChanged((user) => {
      if (user) window.location.href = "index.html";
    });
  </script>
</body>
</html>