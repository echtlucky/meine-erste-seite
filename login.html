<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | echtlucky</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    /* ========== Login Page Layout (Premium) ========== */
    .auth-shell{
      min-height: calc(100vh - 60px);
      display: grid;
      place-items: center;
      padding: clamp(1.2rem, 2.5vw, 2rem);
    }

    .auth-grid{
      width: min(1100px, 100%);
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: clamp(1.2rem, 2.5vw, 2rem);
      align-items: stretch;
    }

    .auth-visual{
      border-radius: var(--radius-xl);
      border: 1px solid rgba(0,255,136,0.16);
      background:
        radial-gradient(circle at 30% 20%, rgba(0,255,136,0.14), transparent 55%),
        radial-gradient(circle at 70% 75%, rgba(88,101,242,0.16), transparent 55%),
        linear-gradient(135deg, rgba(0,255,136,0.06), rgba(0,0,0,0.65));
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
      overflow: hidden;
      position: relative;
      padding: clamp(1.6rem, 2.6vw, 2.6rem);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .auth-visual .badge{
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      padding: .55rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(0,255,136,0.18);
      background: rgba(255,255,255,0.03);
      color: var(--text-soft);
      font-weight: 700;
      width: fit-content;
    }

    .auth-visual h1{
      margin-top: 1rem;
      font-size: clamp(2rem, 3vw, 3rem);
      letter-spacing: -0.9px;
      line-height: 1.15;
      background: linear-gradient(90deg, #00ff88, #00cc66);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-visual p{
      margin-top: .9rem;
      color: var(--text-soft);
      opacity: .95;
      max-width: 52ch;
      font-size: 1.05rem;
    }

    .auth-visual .bullets{
      margin-top: 1.4rem;
      display: grid;
      gap: .75rem;
      color: var(--text-soft);
      opacity: .95;
    }

    .auth-visual .bullet{
      display:flex;
      gap:.8rem;
      align-items:flex-start;
      padding:.85rem 1rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(0,255,136,0.12);
      background: rgba(0,0,0,0.45);
    }

    .auth-visual .dot{
      width: 10px;
      height: 10px;
      margin-top: .35rem;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(0,255,136,0.35);
      flex-shrink: 0;
    }

    .auth-card{
      border-radius: var(--radius-xl);
      border: 1px solid rgba(0,255,136,0.18);
      background: linear-gradient(135deg, rgba(0,255,136,0.06), rgba(0,0,0,0.66));
      box-shadow: 0 26px 90px rgba(0,0,0,0.55);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .auth-card__top{
      padding: 1.4rem 1.5rem 1.1rem;
      border-bottom: 1px solid rgba(0,255,136,0.12);
      background: rgba(0,0,0,0.35);
    }

    .tabs{
      display:flex;
      gap:.7rem;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(0,255,136,0.14);
      padding: .35rem;
      border-radius: 999px;
      width: fit-content;
    }

    .tab{
      appearance: none;
      border: 0;
      cursor: pointer;
      padding: .6rem 1.05rem;
      border-radius: 999px;
      background: transparent;
      color: var(--text-soft);
      font-weight: 800;
      letter-spacing: -0.2px;
      opacity: .9;
      transition: all .18s ease;
    }

    .tab.active{
      background: rgba(0,255,136,0.14);
      color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,255,136,0.14) inset;
      opacity: 1;
    }

    .auth-card__body{
      padding: 1.4rem 1.5rem 1.6rem;
      display: grid;
      gap: 1rem;
    }

    .field{
      display: grid;
      gap: .45rem;
    }

    .field label{
      color: var(--text-soft);
      font-weight: 700;
      font-size: .95rem;
      letter-spacing: -0.2px;
    }

    .input{
      width: 100%;
      padding: .95rem 1rem;
      border-radius: 14px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(0,0,0,0.55);
      color: var(--text);
      outline: none;
      transition: border-color .18s ease, box-shadow .18s ease;
    }

    .input::placeholder{ color: rgba(224,255,224,0.55); }

    .input:focus{
      border-color: rgba(0,255,136,0.35);
      box-shadow: 0 0 0 4px rgba(0,255,136,0.10);
    }

    .row{
      display:flex;
      gap: .9rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }

    .hint{
      color: var(--text-muted);
      font-size: .95rem;
      line-height: 1.4;
    }

    .small-link{
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      opacity: .95;
    }
    .small-link:hover{ text-decoration: underline; }

    .divider{
      display:flex;
      align-items:center;
      gap: .9rem;
      color: rgba(224,255,224,0.55);
      font-weight: 700;
      margin: .2rem 0;
    }
    .divider::before,
    .divider::after{
      content:"";
      height:1px;
      flex:1;
      background: rgba(0,255,136,0.12);
    }

    .btn-full{
      width: 100%;
      text-align: center;
      border-radius: 14px;
      border: 1px solid rgba(0,255,136,0.18);
      background: linear-gradient(180deg, rgba(0,255,136,0.92), rgba(0,204,102,0.85));
      color: #000;
      padding: .95rem 1rem;
      font-weight: 900;
      letter-spacing: -0.25px;
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      box-shadow: 0 14px 40px rgba(0,0,0,0.55);
    }
    .btn-full:hover{
      transform: translateY(-3px);
      filter: saturate(1.05);
      box-shadow: 0 20px 65px rgba(0,255,136,0.12), 0 14px 40px rgba(0,0,0,0.55);
    }

    .btn-ghost{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      padding: .9rem 1rem;
      font-weight: 850;
      cursor: pointer;
      transition: background .18s ease, transform .18s ease;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:.7rem;
    }
    .btn-ghost:hover{
      background: rgba(0,255,136,0.08);
      transform: translateY(-2px);
    }

    .msg{
      padding: .9rem 1rem;
      border-radius: 14px;
      border: 1px solid rgba(0,255,136,0.16);
      background: rgba(0,0,0,0.45);
      color: var(--text-soft);
      display:none;
    }
    .msg.error{
      border-color: rgba(255,51,102,0.35);
      background: rgba(255,51,102,0.10);
      color: #ffb6c8;
    }
    .msg.success{
      border-color: rgba(0,255,136,0.28);
      background: rgba(0,255,136,0.08);
      color: var(--text);
    }

    .hidden{ display:none !important; }

    @media (max-width: 980px){
      .auth-grid{
        grid-template-columns: 1fr;
      }
      .auth-visual{
        display:none; /* optional: wenn du willst, kann man die auch drunter anzeigen */
      }
    }
  </style>
</head>

<body class="page-transition">
  <!-- Header via fetch -->
  <div id="header-placeholder"></div>

  <main class="auth-shell">
    <div class="auth-grid">

      <!-- Left: Visual / Content -->
      <section class="auth-visual">
        <div>
          <div class="badge">⚡ echtlucky • Competitive</div>
          <h1>Willkommen zurück.</h1>
          <p>
            Log dich ein, join den Grind und bleib up-to-date bei Ballistic & Ranked.
            Clean, schnell, ohne Drama.
          </p>

          <div class="bullets">
            <div class="bullet"><span class="dot"></span><div><strong>Community</strong><br><span class="hint">Scrims, Customs, VOD-Talk, Team-Suche.</span></div></div>
            <div class="bullet"><span class="dot"></span><div><strong>Blog</strong><br><span class="hint">Updates, Guides, Insights — alles an einem Ort.</span></div></div>
            <div class="bullet"><span class="dot"></span><div><strong>Account</strong><br><span class="hint">Username, Admin-Features (wenn freigeschaltet).</span></div></div>
          </div>
        </div>

        <p class="hint" style="opacity:.9">
          Tipp: Du kannst dich auch mit <strong>Username</strong> anmelden, wenn du einen gesetzt hast.
        </p>
      </section>

      <!-- Right: Auth Card -->
      <section class="auth-card">
        <div class="auth-card__top">
          <div class="tabs" role="tablist" aria-label="Auth Tabs">
            <button class="tab active" id="tabLogin" type="button">Login</button>
            <button class="tab" id="tabRegister" type="button">Registrieren</button>
          </div>
        </div>

        <div class="auth-card__body">
          <div id="msgBox" class="msg"></div>

          <!-- LOGIN FORM -->
          <form id="loginForm">
            <div class="field">
              <label for="loginIdentifier">E-Mail oder Username</label>
              <input id="loginIdentifier" class="input" type="text" autocomplete="username"
                     placeholder="z.B. lucas oder lucas@email.de" required />
              <div class="hint">Wenn du Username nutzt, wird er automatisch zu deiner E-Mail aufgelöst.</div>
            </div>

            <div class="field">
              <label for="loginPassword">Passwort</label>
              <input id="loginPassword" class="input" type="password" autocomplete="current-password"
                     placeholder="••••••••" required />
            </div>

            <div class="row">
              <a href="#" class="small-link" id="forgotPw">Passwort vergessen?</a>
            </div>

            <button class="btn-full" type="submit">Einloggen</button>

            <div class="divider">oder</div>

            <button class="btn-ghost" type="button" id="googleLoginBtn">
              <span style="font-weight:900;">G</span> Mit Google anmelden
            </button>
          </form>

          <!-- REGISTER FORM -->
          <form id="registerForm" class="hidden">
            <div class="field">
              <label for="regUsername">Username</label>
              <input id="regUsername" class="input" type="text" autocomplete="nickname"
                     placeholder="z.B. echtlucky" required />
              <div class="hint">A-Z / 0-9 / _ / . / - • 3–20 Zeichen</div>
            </div>

            <div class="field">
              <label for="regEmail">E-Mail</label>
              <input id="regEmail" class="input" type="email" autocomplete="email"
                     placeholder="name@email.de" required />
            </div>

            <div class="field">
              <label for="regPassword">Passwort</label>
              <input id="regPassword" class="input" type="password" autocomplete="new-password"
                     placeholder="mind. 6 Zeichen" required />
            </div>

            <button class="btn-full" type="submit">Account erstellen</button>

            <div class="divider">oder</div>

            <button class="btn-ghost" type="button" id="googleRegisterBtn">
              <span style="font-weight:900;">G</span> Mit Google starten
            </button>

            <p class="hint" style="margin-top:.2rem;">
              Mit Registrierung akzeptierst du die Inhalte als privat & nicht-kommerziell.
            </p>
          </form>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer via fetch -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>

  <script>
    document.body.classList.add('loaded');

    // Header laden + init
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        if (typeof initHeaderScripts === "function") initHeaderScripts();
        if (typeof initSmartHeaderScroll === "function") initSmartHeaderScroll();
      });

    // Footer laden
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ====== UI helpers ======
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const msgBox = document.getElementById('msgBox');

    function showMsg(text, type="error"){
      msgBox.textContent = text;
      msgBox.className = "msg " + (type === "success" ? "success" : "error");
      msgBox.style.display = "block";
    }
    function clearMsg(){
      msgBox.style.display = "none";
      msgBox.textContent = "";
      msgBox.className = "msg";
    }

    function setTab(mode){
      clearMsg();
      if (mode === "login"){
        tabLogin.classList.add("active");
        tabRegister.classList.remove("active");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      } else {
        tabRegister.classList.add("active");
        tabLogin.classList.remove("active");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      }
    }
    tabLogin.addEventListener('click', () => setTab("login"));
    tabRegister.addEventListener('click', () => setTab("register"));

    // ====== Username → Email resolver ======
    // Collection: usernames (docId = usernameLower)
    // doc: { email: "..." }
    async function resolveEmailFromIdentifier(identifierRaw){
      const identifier = (identifierRaw || "").trim();
      if (!identifier) throw new Error("Bitte E-Mail oder Username eingeben.");

      // If it looks like an email, use it directly
      if (identifier.includes("@")) return identifier;

      // Otherwise treat as username
      const uname = identifier.toLowerCase();

      if (!window.db) throw new Error("DB nicht verfügbar. Prüfe firebase.js + Firestore SDK.");

      const doc = await db.collection("usernames").doc(uname).get();
      if (!doc.exists) throw new Error("Username nicht gefunden.");
      const data = doc.data();
      if (!data?.email) throw new Error("Username ist nicht korrekt verknüpft.");
      return data.email;
    }

    // Username validation
    function isValidUsername(u){
      const v = (u || "").trim();
      if (v.length < 3 || v.length > 20) return false;
      return /^[a-zA-Z0-9_.-]+$/.test(v);
    }

    // ====== LOGIN ======
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value;
      const password = document.getElementById('loginPassword').value;

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.signInWithEmailAndPassword(email, password);
        showMsg("Eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Login fehlgeschlagen.");
      }
    });

    // ====== REGISTER ======
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsg();

      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!isValidUsername(username)){
        showMsg("Username ungültig. Erlaubt: A-Z, 0-9, _ . - (3–20 Zeichen).");
        return;
      }

      try{
        // Check username availability
        const unameLower = username.toLowerCase();
        const existing = await db.collection("usernames").doc(unameLower).get();
        if (existing.exists){
          showMsg("Username ist schon vergeben.");
          return;
        }

        // Create auth user
        const cred = await auth.createUserWithEmailAndPassword(email, password);

        // Save displayName
        await cred.user.updateProfile({ displayName: username });

        // Save username mapping
        await db.collection("usernames").doc(unameLower).set({
          email: email,
          uid: cred.user.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showMsg("Account erstellt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Registrierung fehlgeschlagen.");
      }
    });

    // ====== GOOGLE AUTH ======
    async function googleSignIn(){
      clearMsg();
      try{
        const result = await auth.signInWithPopup(googleProvider);

        // If user has no displayName, optionally ask later
        // But we can auto-create a username mapping if displayName exists:
        const u = result.user;
        if (u?.displayName){
          const unameLower = u.displayName.toLowerCase().replace(/\s+/g, "").slice(0,20);
          const docRef = db.collection("usernames").doc(unameLower);
          const snap = await docRef.get();
          if (!snap.exists){
            await docRef.set({
              email: u.email,
              uid: u.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }

        showMsg("Mit Google eingeloggt. Weiterleitung…", "success");
        setTimeout(() => window.location.href = "index.html", 650);
      }catch(err){
        showMsg(err?.message || "Google Login fehlgeschlagen.");
      }
    }

    document.getElementById('googleLoginBtn').addEventListener('click', googleSignIn);
    document.getElementById('googleRegisterBtn').addEventListener('click', googleSignIn);

    // ====== PASSWORD RESET ======
    document.getElementById('forgotPw').addEventListener('click', async (e) => {
      e.preventDefault();
      clearMsg();

      const identifier = document.getElementById('loginIdentifier').value.trim();
      if (!identifier){
        showMsg("Bitte zuerst E-Mail oder Username eingeben.");
        return;
      }

      try{
        const email = await resolveEmailFromIdentifier(identifier);
        await auth.sendPasswordResetEmail(email);
        showMsg("Reset-Mail wurde gesendet (falls die Adresse existiert).", "success");
      }catch(err){
        showMsg(err?.message || "Reset fehlgeschlagen.");
      }
    });

    // If already logged in, redirect
    auth.onAuthStateChanged((user) => {
      if (user) window.location.href = "index.html";
    });
  </script>
</body>
</html>