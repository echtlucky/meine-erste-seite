<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/pages/login.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body class="page-transition login-page">
  <!-- Header via fetch -->
  <div id="header-placeholder"></div>

  <main class="auth-shell">
    <div class="auth-wrap">

      <div class="auth-grid">

        <main class="login-discord-shell">
          <section class="discord-card login-hero-card">
            <div style="display:flex;align-items:center;gap:1.5rem;">
              <div style="width:56px;height:56px;border-radius:50%;background:#5865f2;color:#fff;display:flex;align-items:center;justify-content:center;font-size:2rem;">
                <i class="fa-solid fa-right-to-bracket"></i>
              </div>
              <div>
                <div style="font-weight:700;font-size:1.2rem;">Willkommen zurück.</div>
                <div style="color:#b9bbbe;font-size:0.98rem;">Log dich ein, join den Grind und bleib up-to-date bei Ballistic & Ranked. Clean, schnell, ohne Drama.</div>
              </div>
            </div>
            <div style="margin-top:1.2rem;display:flex;gap:1.5rem;flex-wrap:wrap;">
              <div class="admin-stat">
                <span class="admin-stat__label"><i class="fa-solid fa-users"></i> Community</span>
                <span class="admin-stat__value">Scrims, Customs, VOD-Talk, Team-Suche</span>
              </div>
              <div class="admin-stat">
                <span class="admin-stat__label"><i class="fa-solid fa-blog"></i> Blog</span>
                <span class="admin-stat__value">Updates, Guides, Insights</span>
              </div>
              <div class="admin-stat">
                <span class="admin-stat__label"><i class="fa-solid fa-user"></i> Account</span>
                <span class="admin-stat__value">Username, Admin-Features</span>
              </div>
            </div>
            <div style="margin-top:1.2rem;color:#b9bbbe;font-size:0.98rem;">
              <i class="fa-solid fa-lightbulb"></i> Tipp: Du kannst dich auch mit <strong>Username</strong> anmelden, wenn du einen gesetzt hast.
            </div>
          </section>
          <section class="discord-card login-main-card">
            <div style="display:flex;align-items:center;justify-content:center;gap:1.5rem;">
              <button class="btn btn-secondary is-active" id="tabLogin" type="button"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
              <button class="btn btn-secondary" id="tabRegister" type="button"><i class="fa-solid fa-user-plus"></i> Registrieren</button>
            </div>
            <div style="margin-top:2rem;">
              <div id="msgBox" class="msg" style="display:none;"></div>
              <form id="loginForm">
                <div class="field">
                  <label for="loginIdentifier">E-Mail oder Username</label>
                  <input id="loginIdentifier" class="input" type="text" autocomplete="username" placeholder="Nutzername: max1234 oder Email: maxmustermann@gmail.com" required />
                  <div class="hint">Wenn du Username nutzt, wird er automatisch zu deiner E-Mail aufgelöst.</div>
                </div>
                <div class="field">
                  <label for="loginPassword">Passwort</label>
                  <input id="loginPassword" class="input" type="password" autocomplete="current-password" placeholder="••••••••" required />
                </div>
                <div class="field field--actions" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
                  <a href="#" class="link forgot-link" id="forgotLink"><i class="fa-solid fa-key"></i> Passwort vergessen?</a>
                </div>
              </form>
              <form id="registerForm" style="display:none;">
                <div class="field">
                  <label for="registerEmail">E-Mail</label>
                  <input id="registerEmail" class="input" type="email" autocomplete="email" placeholder="Deine E-Mail" required />
                </div>
                <div class="field">
                  <label for="registerPassword">Passwort</label>
                  <input id="registerPassword" class="input" type="password" autocomplete="new-password" placeholder="••••••••" required />
                </div>
                <div class="field field--actions" style="display:flex;align-items:center;justify-content:flex-end;gap:1rem;">
                  <button class="btn btn-primary" type="submit"><i class="fa-solid fa-user-plus"></i> Registrieren</button>
                </div>
              </form>
            </div>
          </section>
        </main>
                  autocomplete="new-password"
                  placeholder="mind. 6 Zeichen"
                  required
                />
              </div>

              <button class="btn-full" type="submit">Account erstellen</button>

              <div class="divider">oder</div>

              <button class="btn-ghost" type="button" id="googleRegisterBtn">
                <span class="google-g">G</span> Mit Google starten
              </button>

              <p class="hint hint--compact">
                Mit Registrierung akzeptierst du die Inhalte als privat & nicht-kommerziell.
              </p>
            </form>
          </div>
        </section>

      </div>

      <!-- Latest Blog (unten) -->
      <section class="auth-latest" id="latestPostCard" aria-live="polite">
        <div class="auth-latest__meta">Letzter Blog</div>
        <h2 class="auth-latest__title" id="latestPostTitle">Lädt…</h2>
        <p class="auth-latest__text" id="latestPostText">Bitte einen Moment.</p>
        <a class="auth-latest__cta" id="latestPostLink" href="blog.html">Zum Blog →</a>
      </section>

    </div>
  </main>

  <!-- Footer via fetch -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- Your setup -->
  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>
  <script src="js/login.js"></script>
  <script src="js/notify.js"></script>
  <script src="js/modal-dialog.js"></script>

  <script>
    document.body.classList.add('loaded');

    // Header laden + init
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        if (typeof initHeaderScripts === "function") initHeaderScripts();
        if (typeof initSmartHeaderScroll === "function") initSmartHeaderScroll();
      });

    // Footer laden
    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ===== Latest Blog Preview (FIX: immer window.db / window.echtlucky.db) =====
    async function loadLatestPostIntoLogin() {
      const titleEl = document.getElementById("latestPostTitle");
      const textEl  = document.getElementById("latestPostText");
      const linkEl  = document.getElementById("latestPostLink");
      if (!titleEl || !textEl || !linkEl) return;

      const dbRef = window.echtlucky?.db || window.db || null;

      if (!dbRef) {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Firestore ist noch nicht bereit (window.db fehlt).";
        linkEl.href = "blog.html";
        linkEl.textContent = "Zum Blog →";
        return;
      }

      const stripHtml = (s) => String(s || "").replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
      const makeExcerpt = (s, max=180) => (s.length > max ? s.slice(0, max).trim() + "…" : s);

      try {
        let snap;
        try {
          snap = await dbRef.collection("posts").orderBy("createdAt", "desc").limit(1).get();
        } catch (e) {
          snap = await dbRef.collection("posts").orderBy("date", "desc").limit(1).get();
        }

        if (!snap || snap.empty) {
          titleEl.textContent = "Aktuell kein Blog vorhanden";
          textEl.textContent = "Sobald ein Beitrag online ist, wird er hier angezeigt.";
          linkEl.href = "blog.html";
          linkEl.textContent = "Zum Blog →";
          return;
        }

        const data = snap.docs[0].data() || {};
        const title = data.title || "Neuer Beitrag";
        const content = stripHtml(data.content || "");
        const excerpt = makeExcerpt(content || "Beitrag ansehen.", 190);

        titleEl.textContent = title;
        textEl.textContent = excerpt;

        linkEl.href = "blog.html";
        linkEl.textContent = "Beitrag lesen →";
      } catch (err) {
        titleEl.textContent = "Aktuell kein Blog vorhanden";
        textEl.textContent = "Konnte den Blog nicht laden: " + (err?.message || "Unbekannter Fehler");
        linkEl.href = "blog.html";
        linkEl.textContent = "Zum Blog →";
      }
    }

    document.addEventListener("DOMContentLoaded", loadLatestPostIntoLogin);
  </script>
</body>
</html>