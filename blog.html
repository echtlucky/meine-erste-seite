<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===== Blog Page Styles (page-specific) ===== */

    .page-title {
      text-align: center;
      margin: 2.2rem 0 0.6rem;
      font-size: 3rem;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0,255,136,0.18);
    }

    .intro {
      text-align: center;
      opacity: 0.85;
      margin-bottom: 2.2rem;
      font-size: 1.15rem;
    }

    /* Loader */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      margin: 4rem auto;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(0,255,136,0.2);
      border-top: 6px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text { font-size: 1.3rem; opacity: 0.8; }

    .no-posts {
      text-align: center;
      font-size: 1.35rem;
      opacity: 0.75;
      margin: 6rem 0;
      color: #aaa;
    }

    /* Blog-Liste */
    .blog-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2.2rem;
      margin: 2.5rem 0 5rem;
      min-height: 300px;
    }

    .blog-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2rem;
      text-align: left;
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
    }

    .blog-card:hover {
      transform: translateY(-8px);
      border-color: rgba(0,255,136,0.55);
      box-shadow: 0 18px 55px rgba(0,255,136,0.12);
    }

    .blog-card h2 {
      color: var(--accent);
      font-size: 1.8rem;
      margin-bottom: 0.8rem;
    }

    .blog-card .meta {
      font-size: 0.95rem;
      opacity: 0.75;
      margin-bottom: 1.1rem;
    }

    .blog-card p {
      font-size: 1.08rem;
      opacity: 0.92;
      margin-bottom: 1.3rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.25s ease;
      padding: 1.5rem;
    }

    .modal.show {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      width: 100%;
      max-width: 900px;
      background: rgba(0,0,0,0.85);
      border: 1px solid rgba(0,255,136,0.35);
      border-radius: 24px;
      padding: 3rem 2.6rem;
      box-shadow: 0 20px 70px rgba(0,255,136,0.18);
      position: relative;
      text-align: left;
      transform: scale(0.92);
      transition: transform 0.25s ease;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal.show .modal-content { transform: scale(1); }

    .modal-close {
      position: absolute;
      top: 1.1rem;
      right: 1.6rem;
      font-size: 2.4rem;
      color: var(--accent);
      cursor: pointer;
      user-select: none;
      line-height: 1;
    }

    .modal h2 {
      color: var(--accent);
      font-size: 2.4rem;
      margin-bottom: 0.9rem;
    }

    .modal .meta {
      font-size: 1.05rem;
      opacity: 0.75;
      margin-bottom: 1.8rem;
    }

    .modal .post-content {
      font-size: 1.15rem;
      line-height: 1.75;
      opacity: 0.95;
      white-space: pre-wrap; /* damit \n sauber angezeigt wird */
    }

    .delete-btn {
      background: #ff3366;
      color: white;
      padding: 1rem 1.6rem;
      border-radius: 12px;
      margin-top: 2rem;
      display: none;
      cursor: pointer;
      border: none;
      font-weight: 700;
    }

    .delete-btn:hover { background: #ff1a4d; }
  </style>
</head>

<body class="page-transition">

  <!-- Header (extern) -->
  <div id="header-placeholder"></div>

  <main class="container">
    <h1 class="page-title">Blog</h1>
    <p class="intro">Meine Gedanken, Erfahrungen und Tipps zum Ballistic- und Ranked-Grind.</p>

    <div id="blog-list" class="blog-list">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">Posts werden geladen...</p>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="postModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">×</span>
      <h2 id="post-title"></h2>
      <p class="meta" id="post-meta"></p>
      <div class="post-content" id="post-content"></div>
      <button class="delete-btn" id="delete-post-btn">Post löschen</button>
    </div>
  </div>

  <!-- Footer (extern) -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- Dein Firebase Setup -->
  <script src="firebase.js"></script>

  <!-- Header/Dropdown/Mobile Menü Logik -->
  <script src="js/menu.js"></script>

  <script>
    // Page transition
    document.body.classList.add('loaded');

    // ===== Header + Footer laden =====
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        initHeaderScripts(); // ✅ nur das – keine doppelte Header-Logik hier
      });

    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ===== Helpers =====
    const ADMIN_EMAIL = "lucassteckel04@gmail.com";

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatPreview(text, len = 160) {
      const clean = String(text || "").replace(/\s+/g, " ").trim();
      return clean.length > len ? clean.slice(0, len) + "…" : clean;
    }

    // ===== Modal Logic =====
    const postModal = document.getElementById('postModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const deletePostBtn = document.getElementById('delete-post-btn');

    let currentPostId = null;
    let canDelete = false;

    function openPostModal({ id, title, meta, content }) {
      document.getElementById('post-title').textContent = title || "";
      document.getElementById('post-meta').textContent = meta || "";
      document.getElementById('post-content').textContent = content || "";

      currentPostId = id;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';

      postModal.style.display = 'flex';
      requestAnimationFrame(() => postModal.classList.add('show'));
      postModal.setAttribute("aria-hidden", "false");
    }

    function closePostModal() {
      postModal.classList.remove('show');
      postModal.setAttribute("aria-hidden", "true");
      setTimeout(() => { postModal.style.display = 'none'; }, 250);
      currentPostId = null;
    }

    modalCloseBtn.addEventListener('click', closePostModal);
    postModal.addEventListener('click', (e) => {
      if (e.target === postModal) closePostModal();
    });

    // ===== Blog Posts laden =====
    function renderLoading() {
      const blogList = document.getElementById('blog-list');
      blogList.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">Posts werden geladen...</p>
        </div>
      `;
    }

    function loadBlogPosts() {
      renderLoading();

      db.collection('posts')
        .orderBy('createdAt', 'desc')
        .get()
        .then((snapshot) => {
          const blogList = document.getElementById('blog-list');
          blogList.innerHTML = '';

          if (snapshot.empty) {
            blogList.innerHTML = '<p class="no-posts">Keine Beiträge vorhanden</p>';
            return;
          }

          snapshot.forEach((doc) => {
            const data = doc.data() || {};

            const title = data.title || "Ohne Titel";
            const date = data.date || "";
            const author = data.author || "Unbekannt";
            const content = data.content || "";

            const card = document.createElement('div');
            card.className = 'blog-card';

            // Safe HTML (nur Text reingeben)
            card.innerHTML = `
              <h2>${escapeHtml(title)}</h2>
              <p class="meta">${escapeHtml(date)}${date ? " • " : ""}von ${escapeHtml(author)}</p>
              <p>${escapeHtml(formatPreview(content))}</p>
              <a href="#" class="btn read-btn" style="display:inline-block;">Lesen</a>
            `;

            // Click handler ohne Inline-onclick (stabil + sicher)
            card.querySelector('.read-btn').addEventListener('click', (e) => {
              e.preventDefault();
              openPostModal({
                id: doc.id,
                title,
                meta: `${date}${date ? " • " : ""}von ${author}`,
                content
              });
            });

            blogList.appendChild(card);
          });
        })
        .catch((err) => {
          console.error(err);
          document.getElementById('blog-list').innerHTML =
            '<p style="color:#ff3366; text-align:center; margin:3rem 0;">Fehler beim Laden: ' +
            escapeHtml(err.message) +
            '</p>';
        });
    }

    // ===== Admin Delete =====
    function updateDeletePermission(user) {
      canDelete = !!user && user.email === ADMIN_EMAIL;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';
    }

    deletePostBtn.addEventListener('click', () => {
      if (!canDelete || !currentPostId) return;

      if (!confirm('Post wirklich löschen?')) return;

      db.collection('posts').doc(currentPostId).delete()
        .then(() => {
          alert('Post gelöscht');
          closePostModal();
          loadBlogPosts();
        })
        .catch((err) => alert('Fehler: ' + err.message));
    });

    // ===== Init =====
    // Posts können auch ohne Login geladen werden.
    loadBlogPosts();

    // Admin-Rechte nur für Delete prüfen
    if (typeof window.auth !== "undefined") {
      auth.onAuthStateChanged((user) => {
        updateDeletePermission(user);
      });
    }
  </script>

</body>
</html>