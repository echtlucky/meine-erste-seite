<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===== Blog Premium (page-specific) ===== */

    .page-head {
      text-align: center;
      margin: 2.6rem 0 1.4rem;
    }

    .page-head h1 {
      font-size: 3.2rem;
      color: var(--accent);
      text-shadow: 0 0 22px rgba(0,255,136,0.18);
      margin-bottom: 0.6rem;
    }

    .page-head p {
      opacity: 0.85;
      font-size: 1.15rem;
      max-width: 820px;
      margin: 0 auto;
    }

    /* Toolbar */
    .blog-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin: 2.2rem 0 1rem;
      flex-wrap: wrap;
    }

    .blog-toolbar .hint {
      opacity: 0.75;
      font-size: 0.98rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(0,255,136,0.22);
      background: rgba(0,255,136,0.06);
      color: var(--text);
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    /* Loader */
    .loading-spinner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 240px;
      margin: 2.2rem auto;
    }

    .spinner {
      width: 56px;
      height: 56px;
      border: 6px solid rgba(0,255,136,0.18);
      border-top: 6px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.2rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text { font-size: 1.15rem; opacity: 0.78; }

    .no-posts {
      text-align: center;
      font-size: 1.25rem;
      opacity: 0.78;
      margin: 4rem 0 5rem;
      color: #aaa;
    }

    /* Grid */
    .blog-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
      margin: 1.6rem 0 2.2rem;
      min-height: 200px;
    }

    /* Premium Card */
    .blog-card {
      position: relative;
      border-radius: 22px;
      padding: 2rem 2rem 1.6rem;
      border: 1px solid rgba(0,255,136,0.22);
      background:
        radial-gradient(circle at 10% 10%, rgba(0,255,136,0.10) 0%, transparent 45%),
        radial-gradient(circle at 90% 30%, rgba(0,255,136,0.06) 0%, transparent 55%),
        rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.55);
      transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
      overflow: hidden;
    }

    .blog-card::after {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(circle at 50% 0%, rgba(0,255,136,0.18), transparent 55%);
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .blog-card:hover {
      transform: translateY(-8px);
      border-color: rgba(0,255,136,0.55);
      box-shadow: 0 28px 85px rgba(0,255,136,0.12), 0 18px 60px rgba(0,0,0,0.6);
    }

    .blog-card:hover::after { opacity: 1; }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      border: 1px solid rgba(0,255,136,0.25);
      background: rgba(0,255,136,0.08);
      color: var(--accent);
      font-weight: 800;
      font-size: 0.9rem;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .meta {
      opacity: 0.78;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    .blog-card h2 {
      font-size: 1.85rem;
      line-height: 1.2;
      margin-bottom: 0.85rem;
      color: var(--accent);
    }

    .preview {
      font-size: 1.08rem;
      opacity: 0.92;
      margin-bottom: 1.35rem;
    }

    .card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-top: 0.8rem;
    }

    .readtime {
      opacity: 0.78;
      font-size: 0.95rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(10px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .modal.show { display: flex; opacity: 1; }

    .modal-content {
      width: 100%;
      max-width: 920px;
      background: rgba(0,0,0,0.86);
      border: 1px solid rgba(0,255,136,0.32);
      border-radius: 26px;
      padding: 3rem 2.6rem;
      box-shadow: 0 24px 90px rgba(0,255,136,0.18);
      position: relative;
      transform: scale(0.94);
      transition: transform 0.25s ease;
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal.show .modal-content { transform: scale(1); }

    .modal-close {
      position: absolute;
      top: 1.1rem;
      right: 1.6rem;
      font-size: 2.4rem;
      color: var(--accent);
      cursor: pointer;
      user-select: none;
      line-height: 1;
    }

    .modal h2 {
      color: var(--accent);
      font-size: 2.55rem;
      margin-bottom: 0.9rem;
    }

    .modal .meta {
      opacity: 0.78;
      font-size: 1.05rem;
      margin-bottom: 1.6rem;
      white-space: normal;
    }

    .modal .post-content {
      font-size: 1.15rem;
      line-height: 1.8;
      opacity: 0.96;
      white-space: pre-wrap;
    }

    .delete-btn {
      background: #ff3366;
      color: white;
      padding: 1rem 1.6rem;
      border-radius: 14px;
      margin-top: 2rem;
      display: none;
      cursor: pointer;
      border: none;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .delete-btn:hover { background: #ff1a4d; }

    /* Load more */
    .load-more-wrap {
      display: flex;
      justify-content: center;
      margin: 1rem 0 4rem;
    }

    .load-more {
      display: none;
    }

    .load-more[disabled] {
      opacity: 0.6;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .page-head h1 { font-size: 2.7rem; }
      .modal-content { padding: 2.4rem 1.8rem; }
      .blog-card { padding: 1.7rem 1.6rem 1.4rem; }
    }
  </style>
</head>

<body class="page-transition">

  <!-- Header (extern) -->
  <div id="header-placeholder"></div>

  <main class="container">
    <div class="page-head">
      <h1>Blog</h1>
      <p>Meine Gedanken, Erfahrungen und Tipps zum Ballistic- und Ranked-Grind ‚Äì clean, kurz, auf den Punkt.</p>
    </div>

    <div class="blog-toolbar">
      <div class="pill" id="postCountPill">üìù 0 Posts</div>
      <div class="hint">Tipp: Klick auf ‚ÄûLesen‚Äú, um den Beitrag im Pop-Up zu √∂ffnen.</div>
    </div>

    <div id="blog-list" class="blog-list">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">Posts werden geladen...</p>
      </div>
    </div>

    <div class="load-more-wrap">
      <a href="#" class="btn load-more" id="loadMoreBtn">Mehr laden</a>
    </div>
  </main>

  <!-- Modal -->
  <div id="postModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">√ó</span>
      <h2 id="post-title"></h2>
      <p class="meta" id="post-meta"></p>
      <div class="post-content" id="post-content"></div>
      <button class="delete-btn" id="delete-post-btn">Post l√∂schen</button>
    </div>
  </div>

  <!-- Footer (extern) -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- Dein Firebase Setup -->
  <script src="firebase.js"></script>

  <!-- Header/Dropdown/Mobile Men√º Logik -->
  <script src="js/menu.js"></script>

  <script>
    document.body.classList.add('loaded');

    // Header + Footer laden
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        initHeaderScripts();
        initSmartHeaderScroll();
      });

    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ===== Settings
    const ADMIN_EMAIL = "lucassteckel04@gmail.com";
    const PAGE_SIZE = 6;

    // ===== State
    let lastDoc = null;
    let hasMore = true;
    let loading = false;
    let currentPostId = null;
    let canDelete = false;
    let totalRendered = 0;

    // ===== DOM
    const blogList = document.getElementById('blog-list');
    const postCountPill = document.getElementById('postCountPill');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    const postModal = document.getElementById('postModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const deletePostBtn = document.getElementById('delete-post-btn');

    // ===== Helpers
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatPreview(text, len = 170) {
      const clean = String(text ?? "").replace(/\s+/g, " ").trim();
      return clean.length > len ? clean.slice(0, len) + "‚Ä¶" : clean;
    }

    function estimateReadTime(text) {
      const words = String(text ?? "").trim().split(/\s+/).filter(Boolean).length;
      const minutes = Math.max(1, Math.round(words / 180)); // ~180 WPM
      return `${minutes} Min. lesen`;
    }

    function setPostCount() {
      postCountPill.textContent = `üìù ${totalRendered} Post${totalRendered === 1 ? "" : "s"}`;
    }

    function renderLoading(isInitial = false) {
      if (isInitial) {
        blogList.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Posts werden geladen...</p>
          </div>
        `;
      }
    }

    function setLoadMoreVisible() {
      loadMoreBtn.style.display = hasMore ? 'inline-block' : 'none';
      loadMoreBtn.toggleAttribute('disabled', loading);
    }

    // ===== Modal
    function openPostModal({ id, title, meta, content }) {
      document.getElementById('post-title').textContent = title || "";
      document.getElementById('post-meta').textContent = meta || "";
      document.getElementById('post-content').textContent = content || "";

      currentPostId = id;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';

      postModal.style.display = 'flex';
      requestAnimationFrame(() => postModal.classList.add('show'));
      postModal.setAttribute("aria-hidden", "false");
    }

    function closePostModal() {
      postModal.classList.remove('show');
      postModal.setAttribute("aria-hidden", "true");
      setTimeout(() => { postModal.style.display = 'none'; }, 250);
      currentPostId = null;
    }

    modalCloseBtn.addEventListener('click', closePostModal);
    postModal.addEventListener('click', (e) => {
      if (e.target === postModal) closePostModal();
    });

    // ===== Delete (Admin)
    function updateDeletePermission(user) {
      canDelete = !!user && user.email === ADMIN_EMAIL;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';
    }

    deletePostBtn.addEventListener('click', () => {
      if (!canDelete || !currentPostId) return;
      if (!confirm('Post wirklich l√∂schen?')) return;

      db.collection('posts').doc(currentPostId).delete()
        .then(() => {
          alert('Post gel√∂scht');

          // UI Reset & reload first page
          closePostModal();
          resetAndReload();
        })
        .catch((err) => alert('Fehler: ' + err.message));
    });

    // ===== Cards (Premium)
    function createCard(doc) {
      const data = doc.data() || {};

      const title = data.title || "Ohne Titel";
      const date = data.date || "";
      const author = data.author || "Unbekannt";
      const content = data.content || "";
      const badgeText = (data.badge || data.category || "Update");
      const readTime = estimateReadTime(content);

      const metaText = `${date}${date ? " ‚Ä¢ " : ""}von ${author}`;

      const card = document.createElement('article');
      card.className = 'blog-card';

      card.innerHTML = `
        <div class="card-top">
          <span class="badge">‚ö° ${escapeHtml(badgeText)}</span>
          <span class="meta">${escapeHtml(metaText)}</span>
        </div>

        <h2>${escapeHtml(title)}</h2>
        <p class="preview">${escapeHtml(formatPreview(content))}</p>

        <div class="card-actions">
          <span class="readtime">‚è±Ô∏è ${escapeHtml(readTime)}</span>
          <a href="#" class="btn read-btn" style="display:inline-block;">Lesen</a>
        </div>
      `;

      card.querySelector('.read-btn').addEventListener('click', (e) => {
        e.preventDefault();
        openPostModal({
          id: doc.id,
          title,
          meta: metaText,
          content
        });
      });

      // Optional: Klick auf ganze Card √∂ffnet Modal
      card.addEventListener('click', (e) => {
        const isButton = e.target.closest('.read-btn');
        if (isButton) return;
        openPostModal({
          id: doc.id,
          title,
          meta: metaText,
          content
        });
      });

      return card;
    }

    // ===== Pagination Query
    function buildQuery() {
      let q = db.collection('posts').orderBy('createdAt', 'desc').limit(PAGE_SIZE);
      if (lastDoc) q = q.startAfter(lastDoc);
      return q;
    }

    function loadNextPage({ initial = false } = {}) {
      if (loading || !hasMore) return;

      loading = true;
      if (initial) renderLoading(true);
      setLoadMoreVisible();

      buildQuery().get()
        .then((snapshot) => {
          if (initial) blogList.innerHTML = "";

          if (snapshot.empty) {
            if (initial) blogList.innerHTML = '<p class="no-posts">Keine Beitr√§ge vorhanden</p>';
            hasMore = false;
            setLoadMoreVisible();
            return;
          }

          // Render cards
          snapshot.forEach((doc) => {
            blogList.appendChild(createCard(doc));
            totalRendered += 1;
          });

          // Update cursor
          lastDoc = snapshot.docs[snapshot.docs.length - 1];

          // If less than page size, no more
          if (snapshot.size < PAGE_SIZE) hasMore = false;

          setPostCount();
          setLoadMoreVisible();
        })
        .catch((err) => {
          console.error(err);
          if (initial) {
            blogList.innerHTML =
              '<p style="color:#ff3366; text-align:center; margin:3rem 0;">Fehler beim Laden: ' +
              escapeHtml(err.message) +
              '</p>';
          } else {
            alert('Fehler beim Nachladen: ' + err.message);
          }
        })
        .finally(() => {
          loading = false;
          setLoadMoreVisible();
        });
    }

    function resetAndReload() {
      lastDoc = null;
      hasMore = true;
      loading = false;
      currentPostId = null;
      totalRendered = 0;
      setPostCount();
      loadNextPage({ initial: true });
    }

    loadMoreBtn.addEventListener('click', (e) => {
      e.preventDefault();
      loadNextPage({ initial: false });
    });

    // ===== Init
    setPostCount();
    resetAndReload();

    if (typeof window.auth !== "undefined") {
      auth.onAuthStateChanged((user) => updateDeletePermission(user));
    }
  </script>

</body>
</html>