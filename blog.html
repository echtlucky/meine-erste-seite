<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog | echtlucky</title>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/components.css" />
  <link rel="stylesheet" href="css/pages/blog.css" />
</head>

<body class="page-transition">

  <!-- Header (extern) -->
  <div id="header-placeholder"></div>

  <main class="container">
    <div class="page-head">
      <h1>Blog</h1>
      <p>Meine Gedanken, Erfahrungen und Tipps zum Ballistic- und Ranked-Grind ‚Äì clean, kurz, auf den Punkt.</p>
    </div>

    <div class="blog-toolbar">
      <div class="pill" id="postCountPill">üìù 0 Posts</div>
      <div class="hint">Tipp: Klick auf ‚ÄûLesen‚Äú, um den Beitrag im Pop-Up zu √∂ffnen.</div>
    </div>

    <div id="blog-list" class="blog-list">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">Posts werden geladen...</p>
      </div>
    </div>

    <div class="load-more-wrap">
      <a href="#" class="btn load-more" id="loadMoreBtn">Mehr laden</a>
    </div>
  </main>

  <!-- Modal -->
  <div id="postModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">√ó</span>
      <h2 id="post-title"></h2>
      <p class="meta" id="post-meta"></p>
      <div class="post-content" id="post-content"></div>
      <button class="delete-btn" id="delete-post-btn">Post l√∂schen</button>
    </div>
  </div>

  <!-- Footer (extern) -->
  <div id="footer-placeholder"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <!-- Dein Firebase Setup -->
  <script src="firebase.js"></script>
  <script src="js/menu.js"></script>
  <script src="js/legal-modal.js"></script>

  <script>
    document.body.classList.add('loaded');

    // Header + Footer laden
    fetch('header.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        initHeaderScripts();
        initSmartHeaderScroll();
      });

    fetch('footer.html')
      .then(r => r.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      });

    // ===== Settings
    const ADMIN_EMAIL = "lucassteckel04@gmail.com";
    const PAGE_SIZE = 6;

    // ===== State
    let lastDoc = null;
    let hasMore = true;
    let loading = false;
    let currentPostId = null;
    let canDelete = false;
    let totalRendered = 0;

    // ===== DOM
    const blogList = document.getElementById('blog-list');
    const postCountPill = document.getElementById('postCountPill');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    const postModal = document.getElementById('postModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const deletePostBtn = document.getElementById('delete-post-btn');

    // ===== Helpers
    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function formatPreview(text, len = 170) {
      const clean = String(text ?? "").replace(/\s+/g, " ").trim();
      return clean.length > len ? clean.slice(0, len) + "‚Ä¶" : clean;
    }

    function estimateReadTime(text) {
      const words = String(text ?? "").trim().split(/\s+/).filter(Boolean).length;
      const minutes = Math.max(1, Math.round(words / 180)); // ~180 WPM
      return `${minutes} Min. lesen`;
    }

    function setPostCount() {
      postCountPill.textContent = `üìù ${totalRendered} Post${totalRendered === 1 ? "" : "s"}`;
    }

    function renderLoading(isInitial = false) {
      if (isInitial) {
        blogList.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p class="loading-text">Posts werden geladen...</p>
          </div>
        `;
      }
    }

    function setLoadMoreVisible() {
      loadMoreBtn.style.display = hasMore ? 'inline-block' : 'none';
      loadMoreBtn.toggleAttribute('disabled', loading);
    }

    // ===== Modal
    function openPostModal({ id, title, meta, content }) {
      document.getElementById('post-title').textContent = title || "";
      document.getElementById('post-meta').textContent = meta || "";
      document.getElementById('post-content').textContent = content || "";

      currentPostId = id;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';

      postModal.style.display = 'flex';
      requestAnimationFrame(() => postModal.classList.add('show'));
      postModal.setAttribute("aria-hidden", "false");
    }

    function closePostModal() {
      postModal.classList.remove('show');
      postModal.setAttribute("aria-hidden", "true");
      setTimeout(() => { postModal.style.display = 'none'; }, 250);
      currentPostId = null;
    }

    modalCloseBtn.addEventListener('click', closePostModal);
    postModal.addEventListener('click', (e) => {
      if (e.target === postModal) closePostModal();
    });

    // ===== Delete (Admin)
    function updateDeletePermission(user) {
      canDelete = !!user && user.email === ADMIN_EMAIL;
      deletePostBtn.style.display = (canDelete && currentPostId) ? 'inline-block' : 'none';
    }

    deletePostBtn.addEventListener('click', () => {
      if (!canDelete || !currentPostId) return;
      if (!confirm('Post wirklich l√∂schen?')) return;

      db.collection('posts').doc(currentPostId).delete()
        .then(() => {
          alert('Post gel√∂scht');
          closePostModal();
          resetAndReload();
        })
        .catch((err) => alert('Fehler: ' + err.message));
    });

    // ===== Cards
    function createCard(doc) {
      const data = doc.data() || {};

      const title = data.title || "Ohne Titel";
      const date = data.date || "";
      const author = data.author || "Unbekannt";
      const content = data.content || "";
      const badgeText = (data.badge || data.category || "Update");
      const readTime = estimateReadTime(content);

      const metaText = `${date}${date ? " ‚Ä¢ " : ""}von ${author}`;

      const card = document.createElement('article');
      card.className = 'blog-card';

      card.innerHTML = `
        <div class="card-top">
          <span class="blog-badge">‚ö° ${escapeHtml(badgeText)}</span>
          <span class="meta">${escapeHtml(metaText)}</span>
        </div>

        <h2>${escapeHtml(title)}</h2>
        <p class="preview">${escapeHtml(formatPreview(content))}</p>

        <div class="card-actions">
          <span class="readtime">‚è±Ô∏è ${escapeHtml(readTime)}</span>
          <a href="#" class="btn read-btn" style="display:inline-block;">Lesen</a>
        </div>
      `;

      card.querySelector('.read-btn').addEventListener('click', (e) => {
        e.preventDefault();
        openPostModal({ id: doc.id, title, meta: metaText, content });
      });

      card.addEventListener('click', (e) => {
        const isButton = e.target.closest('.read-btn');
        if (isButton) return;
        openPostModal({ id: doc.id, title, meta: metaText, content });
      });

      return card;
    }

    function buildQuery() {
      let q = db.collection('posts').orderBy('createdAt', 'desc').limit(PAGE_SIZE);
      if (lastDoc) q = q.startAfter(lastDoc);
      return q;
    }

    function loadNextPage({ initial = false } = {}) {
      if (loading || !hasMore) return;

      loading = true;
      if (initial) renderLoading(true);
      setLoadMoreVisible();

      buildQuery().get()
        .then((snapshot) => {
          if (initial) blogList.innerHTML = "";

          if (snapshot.empty) {
            if (initial) blogList.innerHTML = '<p class="no-posts">Keine Beitr√§ge vorhanden</p>';
            hasMore = false;
            setLoadMoreVisible();
            return;
          }

          snapshot.forEach((doc) => {
            blogList.appendChild(createCard(doc));
            totalRendered += 1;
          });

          lastDoc = snapshot.docs[snapshot.docs.length - 1];
          if (snapshot.size < PAGE_SIZE) hasMore = false;

          setPostCount();
          setLoadMoreVisible();
        })
        .catch((err) => {
          console.error(err);
          if (initial) {
            blogList.innerHTML =
              '<p style="color:#ff3366; text-align:center; margin:3rem 0;">Fehler beim Laden: ' +
              escapeHtml(err.message) +
              '</p>';
          } else {
            alert('Fehler beim Nachladen: ' + err.message);
          }
        })
        .finally(() => {
          loading = false;
          setLoadMoreVisible();
        });
    }

    function resetAndReload() {
      lastDoc = null;
      hasMore = true;
      loading = false;
      currentPostId = null;
      totalRendered = 0;
      setPostCount();
      loadNextPage({ initial: true });
    }

    loadMoreBtn.addEventListener('click', (e) => {
      e.preventDefault();
      loadNextPage({ initial: false });
    });

    setPostCount();
    resetAndReload();

    if (typeof window.auth !== "undefined") {
      auth.onAuthStateChanged((user) => updateDeletePermission(user));
    }
  </script>

</body>
</html>